<!DOCTYPE html>
<html>
<head>
    <title>Custom Table Review System</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .review-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .header {
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .progress {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .nav-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 14px;
        }
        
        .nav-btn:hover {
            background: #f5f5f5;
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .current-table {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .table-info {
            margin-bottom: 15px;
        }
        
        .table-hash {
            font-family: monospace;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
            margin-left: 10px;
        }
        
        .context-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .context-item {
            background: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        
        .context-label {
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }
        
        .versions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .version-badge {
            background: #007bff;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
        }
        
        .pdf-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .pdf-link {
            color: #007bff;
            text-decoration: none;
            font-size: 12px;
        }
        
        .pdf-link:hover {
            text-decoration: underline;
        }
        
        .table-editor {
            border: 2px solid #007bff;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
            background: white;
        }
        
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .editor-title {
            font-size: 16px;
            font-weight: 600;
            color: #007bff;
        }
        
        .table-controls {
            display: flex;
            gap: 8px;
        }
        
        .table-btn {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            font-size: 12px;
        }
        
        .table-btn:hover {
            background: #f5f5f5;
        }
        
        .custom-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        
        .custom-table th,
        .custom-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            vertical-align: top;
            min-width: 100px;
        }
        
        .custom-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        .custom-table td {
            background: white;
        }
        
        .custom-table td[contenteditable="true"]:focus {
            outline: 2px solid #007bff;
            outline-offset: -2px;
            background: #fff3cd;
        }
        
        .custom-table td.modified {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .table-status-control {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .status-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            display: block;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background: white;
            transition: all 0.2s;
        }
        
        .radio-option:hover {
            background: #f5f5f5;
            border-color: #999;
        }
        
        .radio-option input[type="radio"] {
            margin-right: 8px;
            cursor: pointer;
        }
        
        .radio-option input[type="radio"]:checked + .radio-label {
            font-weight: 600;
        }
        
        .radio-option:has(input[value="undefined"]:checked) {
            background: #fff3cd;
            border-color: #ffeaa7;
        }
        
        .radio-option:has(input[value="confirmed"]:checked) {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        
        .radio-option:has(input[value="rejected"]:checked) {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .radio-label {
            font-size: 14px;
            color: #333;
        }
        
        .table-operations {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .operation-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-confirm {
            background: #28a745;
            color: white;
        }
        
        .btn-confirm:hover {
            background: #218838;
        }
        
        .btn-reject {
            background: #dc3545;
            color: white;
        }
        
        .btn-reject:hover {
            background: #c82333;
        }
        
        .btn-merge {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-merge:hover {
            background: #e0a800;
        }
        
        .btn-skip {
            background: #6c757d;
            color: white;
        }
        
        .btn-skip:hover {
            background: #5a6268;
        }
        
        .status-display {
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            margin-left: auto;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-edited {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-merged {
            background: #e2e3e5;
            color: #383d41;
        }
        
        .final-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }
        
        .final-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }
        
        .btn-save {
            background: #28a745;
            color: white;
        }
        
        .btn-export {
            background: #007bff;
            color: white;
        }
        
        .btn-cancel {
            background: #6c757d;
            color: white;
        }
        
        .completion-message {
            text-align: center;
            padding: 40px;
            background: #d4edda;
            border-radius: 6px;
            color: #155724;
        }
        
        .completion-message h2 {
            color: #155724;
            margin-bottom: 10px;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="review-container">
        <div class="header">
            <div class="title" id="title">Custom Table Review System</div>
            <div class="progress" id="progress">Initializing...</div>
            
            <div class="navigation">
                <button class="nav-btn" id="prev-btn" onclick="previousTable()" disabled>‚Üê Previous</button>
                <button class="nav-btn" id="next-btn" onclick="nextTable()" disabled>Next ‚Üí</button>
                <button class="nav-btn" id="overview-btn" onclick="showOverview()">Overview</button>
            </div>
        </div>
        
        <div id="table-review-section">
            <div class="current-table" id="current-table">
                <div class="table-info">
                    <span>Table <span id="table-number">1</span> of <span id="total-tables">0</span></span>
                    <span class="table-hash" id="table-hash">hash</span>
                    <div class="status-display status-pending" id="table-status">Pending</div>
                </div>
                
                <div class="context-info">
                    <div class="context-item">
                        <div class="context-label">Found in versions:</div>
                        <div class="versions" id="versions-display"></div>
                    </div>
                    <div class="context-item">
                        <div class="context-label">Pages:</div>
                        <div id="pages-display"></div>
                    </div>
                    <div class="context-item">
                        <div class="context-label">PDF Documents:</div>
                        <div class="pdf-links" id="pdf-links"></div>
                    </div>
                    <div class="context-item">
                        <div class="context-label">Structure:</div>
                        <div id="structure-info"></div>
                    </div>
                </div>
                
                <div class="table-editor">
                    <div class="editor-header">
                        <div class="editor-title">Table Editor</div>
                        <div class="table-controls">
                            <button class="table-btn" onclick="addRow()">+ Row</button>
                            <button class="table-btn" onclick="addColumn()">+ Column</button>
                            <button class="table-btn" onclick="removeRow()">- Row</button>
                            <button class="table-btn" onclick="removeColumn()">- Column</button>
                            <button class="table-btn" onclick="resetTable()">Reset</button>
                        </div>
                    </div>
                    
                    <div id="table-container">
                        <!-- Table will be generated here -->
                    </div>
                </div>
                
                <div class="table-status-control">
                    <label class="status-label">Table Status:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="table-status" value="undefined" checked onchange="updateTableStatus('undefined')">
                            <span class="radio-label">Undefined</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="table-status" value="confirmed" onchange="updateTableStatus('confirmed')">
                            <span class="radio-label">‚úì Confirmed</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="table-status" value="rejected" onchange="updateTableStatus('rejected')">
                            <span class="radio-label">‚úó Rejected</span>
                        </label>
                    </div>
                </div>
                
                <div class="table-operations">
                    <button class="operation-btn btn-merge" onclick="mergeTable()">
                        ‚ü± Merge with Next
                    </button>
                    <button class="operation-btn btn-skip" onclick="skipTable()">
                        ‚Üí Skip for Now
                    </button>
                </div>
            </div>
        </div>
        
        <div id="completion-section" class="hidden">
            <div class="completion-message">
                <h2>üéâ Review Complete!</h2>
                <p>All tables have been reviewed.</p>
                <p id="review-summary"></p>
            </div>
        </div>
        
        <div class="final-actions">
            <button class="final-btn btn-save" onclick="saveCorrections()">Save All Corrections</button>
            <button class="final-btn btn-export" onclick="exportCorrections()">Export JSON</button>
            <button class="final-btn btn-cancel" onclick="cancelReview()">Cancel Review</button>
        </div>
    </div>

    <script>
        // Global state
        let lawData = null;
        let currentTableIndex = 0;
        let corrections = {};
        let tableData = {};
        
        // Initialize the review system
        function initReview(data) {
            console.log('üöÄ Initializing custom table review:', data);
            lawData = data;
            corrections = {};
            currentTableIndex = 0;
            
            document.getElementById('title').textContent = `Law ${data.law_id} - Table Review`;
            document.getElementById('total-tables').textContent = data.tables.length;
            
            // Initialize table data storage
            data.tables.forEach(table => {
                tableData[table.hash] = JSON.parse(JSON.stringify(table.structure)); // Deep copy
            });
            
            if (data.tables.length === 0) {
                showCompletion();
            } else {
                showTable(0);
            }
            
            updateNavigation();
            console.log('‚úÖ Custom review system initialized');
        }
        
        // Show specific table
        function showTable(index) {
            if (index < 0 || index >= lawData.tables.length) return;
            
            currentTableIndex = index;
            const table = lawData.tables[index];
            
            console.log(`üìã Showing table ${index + 1}:`, table);
            
            // Update table info
            document.getElementById('table-number').textContent = index + 1;
            document.getElementById('table-hash').textContent = table.hash.substring(0, 12) + '...';
            
            // Update status
            const status = corrections[table.hash] ? corrections[table.hash].status : 'undefined';
            let displayStatus = status === 'undefined' ? 'pending' : status;
            
            // Check if merged into another table
            if (status === 'merged' && corrections[table.hash].merged_into) {
                displayStatus = `Merged into table ${corrections[table.hash].merged_into.substring(0, 8)}...`;
            }
            
            const statusEl = document.getElementById('table-status');
            statusEl.textContent = displayStatus;
            statusEl.className = `status-display status-${status === 'undefined' ? 'pending' : status}`;
            
            // Set radio button
            const radioStatus = status === 'pending' ? 'undefined' : status;
            const radioButtons = document.querySelectorAll('input[name="table-status"]');
            radioButtons.forEach(radio => {
                radio.checked = radio.value === radioStatus;
                // Disable radio buttons for merged tables
                radio.disabled = status === 'merged';
            });
            
            // Also disable merge button if current table is merged
            const mergeBtn = document.querySelector('.btn-merge');
            if (mergeBtn) {
                mergeBtn.disabled = status === 'merged';
                mergeBtn.style.opacity = status === 'merged' ? '0.5' : '1';
            }
            
            // Update context info
            const versionsEl = document.getElementById('versions-display');
            versionsEl.innerHTML = table.found_in_versions
                .map(v => `<span class="version-badge">${v}</span>`)
                .join('');
            
            const pagesEl = document.getElementById('pages-display');
            pagesEl.textContent = Object.entries(table.pages)
                .map(([v, p]) => `v${v}: ${Array.isArray(p) ? p.join(', ') : p}`)
                .join(' | ');
            
            const pdfLinksEl = document.getElementById('pdf-links');
            // Use source_links if available, otherwise fallback to pdf_paths
            if (table.source_links) {
                pdfLinksEl.innerHTML = Object.entries(table.source_links)
                    .map(([v, link]) => link ? `<a href="${link}" class="pdf-link" target="_blank">View v${v} on zh.ch</a>` : '')
                    .filter(link => link)  // Remove empty links
                    .join('');
            } else {
                // Fallback to pdf_paths if source_links not available
                pdfLinksEl.innerHTML = Object.entries(table.pdf_paths)
                    .map(([v, path]) => `<a href="file://${path}" class="pdf-link" target="_blank">View v${v}</a>`)
                    .join('');
            }
            
            const structureEl = document.getElementById('structure-info');
            structureEl.textContent = `${table.structure.length} rows √ó ${table.structure[0] ? table.structure[0].length : 0} columns`;
            
            // Render table
            renderTable(table.hash);
            
            // Set correct editable state based on status
            const isConfirmed = status === 'confirmed';
            setTableEditable(isConfirmed);
            
            // Update navigation
            updateNavigation();
            updateProgress();
        }
        
        // Render table with custom editor
        function renderTable(tableHash) {
            const container = document.getElementById('table-container');
            const structure = tableData[tableHash];
            
            if (!structure || structure.length === 0) {
                container.innerHTML = '<p>No table data available</p>';
                return;
            }
            
            let html = '<table class="custom-table" id="editable-table">';
            
            // Render rows
            for (let i = 0; i < structure.length; i++) {
                html += '<tr>';
                for (let j = 0; j < structure[i].length; j++) {
                    const cellContent = structure[i][j] || '';
                    const isHeader = i === 0;
                    const tag = isHeader ? 'th' : 'td';
                    
                    if (isHeader) {
                        html += `<${tag}>${cellContent}</${tag}>`;
                    } else {
                        html += `<td contenteditable="true" 
                                    data-row="${i}" 
                                    data-col="${j}"
                                    onblur="updateCell(${i}, ${j}, this.textContent)"
                                    oninput="markModified(this)">${cellContent}</td>`;
                    }
                }
                html += '</tr>';
            }
            
            html += '</table>';
            container.innerHTML = html;
            
            console.log(`‚úÖ Rendered table ${tableHash} with ${structure.length} rows`);
        }
        
        // Update cell data
        function updateCell(row, col, content) {
            const table = lawData.tables[currentTableIndex];
            if (!tableData[table.hash]) return;
            
            // Ensure structure exists
            while (tableData[table.hash].length <= row) {
                tableData[table.hash].push([]);
            }
            while (tableData[table.hash][row].length <= col) {
                tableData[table.hash][row].push('');
            }
            
            tableData[table.hash][row][col] = content;
            console.log(`üìù Updated cell [${row}][${col}] = "${content}"`);
            
            // Auto-mark as confirmed when editing (if not already set)
            if (!corrections[table.hash] || corrections[table.hash].status === 'undefined') {
                // Set radio button to confirmed
                const confirmedRadio = document.querySelector('input[name="table-status"][value="confirmed"]');
                if (confirmedRadio) {
                    confirmedRadio.checked = true;
                    updateTableStatus('confirmed');
                }
            }
        }
        
        // Mark cell as modified visually
        function markModified(cell) {
            cell.classList.add('modified');
        }
        
        // Table manipulation functions
        function addRow() {
            const table = lawData.tables[currentTableIndex];
            const structure = tableData[table.hash];
            const columns = structure[0] ? structure[0].length : 1;
            
            structure.push(new Array(columns).fill(''));
            renderTable(table.hash);
            updateTableStructureWithoutStatusChange();
        }
        
        function addColumn() {
            const table = lawData.tables[currentTableIndex];
            const structure = tableData[table.hash];
            
            structure.forEach(row => row.push(''));
            renderTable(table.hash);
            updateTableStructureWithoutStatusChange();
        }
        
        function removeRow() {
            const table = lawData.tables[currentTableIndex];
            const structure = tableData[table.hash];
            
            if (structure.length > 1) {
                structure.pop();
                renderTable(table.hash);
                updateTableStructureWithoutStatusChange();
            }
        }
        
        function removeColumn() {
            const table = lawData.tables[currentTableIndex];
            const structure = tableData[table.hash];
            
            if (structure[0] && structure[0].length > 1) {
                structure.forEach(row => row.pop());
                renderTable(table.hash);
                updateTableStructureWithoutStatusChange();
            }
        }
        
        function updateTableStructureWithoutStatusChange() {
            const table = lawData.tables[currentTableIndex];
            
            // Update the corrected structure if table is already confirmed
            if (corrections[table.hash] && corrections[table.hash].status === 'confirmed') {
                corrections[table.hash].corrected_structure = tableData[table.hash];
                console.log(`üìù Updated table structure while maintaining confirmed status`);
            }
        }
        
        function resetTable() {
            const table = lawData.tables[currentTableIndex];
            tableData[table.hash] = JSON.parse(JSON.stringify(table.structure));
            renderTable(table.hash);
            
            // Reset status
            if (corrections[table.hash]) {
                corrections[table.hash].status = 'pending';
                delete corrections[table.hash].corrected_structure;
            }
            
            showTable(currentTableIndex); // Refresh display
        }
        
        // Table status control
        function updateTableStatus(status) {
            const table = lawData.tables[currentTableIndex];
            
            if (status === 'undefined') {
                // Remove correction if set to undefined
                if (corrections[table.hash]) {
                    delete corrections[table.hash];
                }
                // Disable editing when undefined
                setTableEditable(false);
            } else if (status === 'confirmed') {
                corrections[table.hash] = {
                    hash: table.hash,
                    status: 'confirmed',
                    found_in_versions: table.found_in_versions,
                    pages: table.pages,
                    pdf_paths: table.pdf_paths,
                    source_links: table.source_links,
                    original_structure: table.structure,
                    corrected_structure: tableData[table.hash]
                };
                // Enable editing when confirmed
                setTableEditable(true);
                console.log(`‚úÖ Confirmed table ${table.hash}`);
            } else if (status === 'rejected') {
                corrections[table.hash] = {
                    hash: table.hash,
                    status: 'rejected',
                    found_in_versions: table.found_in_versions,
                    pages: table.pages,
                    reason: 'Rejected by user'
                };
                // Disable editing when rejected
                setTableEditable(false);
                console.log(`‚ùå Rejected table ${table.hash}`);
            }
            
            // Update status display
            const statusEl = document.getElementById('table-status');
            statusEl.textContent = status;
            statusEl.className = `status-display status-${status === 'undefined' ? 'pending' : status}`;
            
            updateProgress();
        }
        
        // Enable/disable table editing
        function setTableEditable(editable) {
            const cells = document.querySelectorAll('#editable-table td[contenteditable]');
            cells.forEach(cell => {
                cell.contentEditable = editable;
                if (editable) {
                    cell.style.cursor = 'text';
                    cell.style.backgroundColor = '';
                } else {
                    cell.style.cursor = 'not-allowed';
                    cell.style.backgroundColor = '#f5f5f5';
                }
            });
            
            // Enable/disable table manipulation buttons
            const tableButtons = document.querySelectorAll('.table-controls button');
            tableButtons.forEach(btn => {
                btn.disabled = !editable;
                btn.style.opacity = editable ? '1' : '0.5';
            });
        }
        
        function markTableAsEdited() {
            const table = lawData.tables[currentTableIndex];
            corrections[table.hash] = {
                hash: table.hash,
                status: 'edited',
                found_in_versions: table.found_in_versions,
                pages: table.pages,
                pdf_paths: table.pdf_paths,
                original_structure: table.structure,
                corrected_structure: tableData[table.hash]
            };
            
            showTable(currentTableIndex);
        }
        
        function mergeTable() {
            const table = lawData.tables[currentTableIndex];
            const nextTableIndex = currentTableIndex + 1;
            
            // Check if there's a next table to merge
            if (nextTableIndex >= lawData.tables.length) {
                alert('No next table available to merge');
                return;
            }
            
            const nextTable = lawData.tables[nextTableIndex];
            
            // Mark current table as confirmed (since we're editing it)
            corrections[table.hash] = {
                hash: table.hash,
                status: 'confirmed',
                found_in_versions: table.found_in_versions,
                pages: table.pages,
                pdf_paths: table.pdf_paths,
                source_links: table.source_links,
                original_structure: table.structure,
                corrected_structure: tableData[table.hash],
                merged_with: nextTable.hash
            };
            
            // Mark next table as merged
            corrections[nextTable.hash] = {
                hash: nextTable.hash,
                status: 'merged',
                found_in_versions: nextTable.found_in_versions,
                pages: nextTable.pages,
                merged_into: table.hash,
                reason: 'Merged into previous table'
            };
            
            // Append next table's data to current table
            const currentData = tableData[table.hash];
            const nextData = tableData[nextTable.hash] || nextTable.structure;
            
            // Add a separator row (optional)
            currentData.push(['--- Merged from next table ---']);
            
            // Append all rows from next table
            nextData.forEach(row => {
                // Ensure the row has the same number of columns
                const newRow = [];
                const targetCols = currentData[0] ? currentData[0].length : row.length;
                for (let i = 0; i < targetCols; i++) {
                    newRow.push(row[i] || '');
                }
                currentData.push(newRow);
            });
            
            // Update the corrected structure
            corrections[table.hash].corrected_structure = currentData;
            
            // Re-render the table
            renderTable(table.hash);
            
            // Set radio button to confirmed
            const confirmedRadio = document.querySelector('input[name="table-status"][value="confirmed"]');
            if (confirmedRadio) {
                confirmedRadio.checked = true;
            }
            setTableEditable(true);
            
            console.log(`‚ü± Merged table ${nextTable.hash} into ${table.hash}`);
            updateProgress();
        }
        
        function skipTable() {
            // Just move to next without making changes
            nextTable();
        }
        
        // Navigation
        function previousTable() {
            if (currentTableIndex > 0) {
                showTable(currentTableIndex - 1);
            }
        }
        
        function nextTable() {
            if (currentTableIndex < lawData.tables.length - 1) {
                showTable(currentTableIndex + 1);
            } else {
                showCompletion();
            }
        }
        
        function updateNavigation() {
            document.getElementById('prev-btn').disabled = currentTableIndex === 0;
            document.getElementById('next-btn').disabled = currentTableIndex >= lawData.tables.length - 1;
        }
        
        function updateProgress() {
            const completed = Object.keys(corrections).length;
            const total = lawData.tables.length;
            document.getElementById('progress').textContent = 
                `Progress: ${completed}/${total} tables reviewed (${Math.round(completed/total*100)}%)`;
        }
        
        function showOverview() {
            let summary = 'Review Summary:\n\n';
            lawData.tables.forEach((table, index) => {
                const status = corrections[table.hash] ? corrections[table.hash].status : 'pending';
                summary += `Table ${index + 1} (${table.hash.substring(0, 8)}...): ${status}\n`;
            });
            alert(summary);
        }
        
        function showCompletion() {
            document.getElementById('table-review-section').classList.add('hidden');
            document.getElementById('completion-section').classList.remove('hidden');
            
            const completed = Object.keys(corrections).length;
            const total = lawData.tables.length;
            const summary = `Reviewed ${completed} out of ${total} tables.`;
            document.getElementById('review-summary').textContent = summary;
        }
        
        // Save and export
        function saveCorrections() {
            // Update all edited tables
            Object.keys(corrections).forEach(hash => {
                if (corrections[hash].status === 'edited') {
                    corrections[hash].corrected_structure = tableData[hash];
                }
            });
            
            fetch('/save-corrections', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(corrections)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('‚úÖ Corrections saved successfully!');
                } else {
                    throw new Error(data.error || 'Save failed');
                }
            })
            .catch(error => {
                console.warn('Server save failed:', error);
                exportCorrections();
                alert('‚¨áÔ∏è Corrections exported as file!');
            });
        }
        
        function exportCorrections() {
            // Update corrections with current table data
            Object.keys(corrections).forEach(hash => {
                if (corrections[hash].status === 'edited') {
                    corrections[hash].corrected_structure = tableData[hash];
                }
            });
            
            const dataStr = JSON.stringify(corrections, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', `${lawData.law_id}-corrections.json`);
            link.click();
        }
        
        function cancelReview() {
            if (confirm('Cancel review? All unsaved changes will be lost.')) {
                if (window.parent && window.parent.cancelReview) {
                    window.parent.cancelReview();
                } else {
                    window.close();
                }
            }
        }
        
        // Load data
        function loadData() {
            fetch('/data.json')
                .then(response => response.json())
                .then(data => {
                    console.log('üì• Loaded data from server');
                    initReview(data);
                })
                .catch(error => {
                    console.warn('Failed to load from server:', error);
                    
                    // Fallback to sample data
                    const sampleData = {
                        law_id: '170.4',
                        tables: [{
                            hash: 'sample123',
                            found_in_versions: ['118'],
                            pages: {'118': [2]},
                            pdf_paths: {'118': '/sample.pdf'},
                            structure: [
                                ['Header 1', 'Header 2'],
                                ['Cell 1', 'Cell 2'],
                                ['Cell 3', 'Cell 4']
                            ]
                        }]
                    };
                    
                    console.log('üì• Using sample data');
                    initReview(sampleData);
                });
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', loadData);
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        previousTable();
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        nextTable();
                        break;
                    case 's':
                        e.preventDefault();
                        saveCorrections();
                        break;
                }
            }
        });
    </script>
</body>
</html>